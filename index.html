<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>W29N04GZ SLC NAND Virtual Simulator</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a2e 50%, #0f0f23 100%);
            color: #00ff88;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .header {
            background: linear-gradient(90deg, #1a1a2e 0%, #16213e 50%, #1a1a2e 100%);
            padding: 20px;
            border-bottom: 2px solid #00ff88;
            text-align: center;
        }

        .header h1 {
            font-size: 1.8rem;
            text-shadow: 0 0 20px #00ff88;
            letter-spacing: 3px;
        }

        .header .subtitle {
            color: #888;
            margin-top: 5px;
            font-size: 0.9rem;
        }

        .container {
            display: grid;
            grid-template-columns: 320px 1fr 320px;
            gap: 20px;
            padding: 20px;
            max-width: 1600px;
            margin: 0 auto;
            padding-bottom: 60px;
        }

        .panel {
            background: rgba(20, 20, 40, 0.9);
            border: 1px solid #333;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 0 20px rgba(0,255,136,0.1);
        }

        .panel-title {
            font-size: 0.9rem;
            color: #00ccff;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        /* Chip Visualization */
        .chip-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
        }

        .chip {
            width: 240px;
            height: 100px;
            background: linear-gradient(145deg, #1a1a1a 0%, #2d2d2d 50%, #1a1a1a 100%);
            border: 3px solid #444;
            border-radius: 8px;
            position: relative;
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
            margin: 20px 0;
        }

        .chip::before {
            content: 'WINBOND';
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            color: #666;
            font-size: 0.7rem;
            letter-spacing: 3px;
        }

        .chip::after {
            content: 'W29N04GZ';
            position: absolute;
            top: 35px;
            left: 50%;
            transform: translateX(-50%);
            color: #888;
            font-size: 1rem;
            font-weight: bold;
        }

        .chip-label {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            color: #555;
            font-size: 0.6rem;
        }

        .chip-dot {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 10px;
            height: 10px;
            background: radial-gradient(circle at 30% 30%, #555, #222);
            border-radius: 50%;
        }

        .pins-row {
            display: flex;
            justify-content: space-around;
            width: 220px;
        }

        .pin {
            width: 6px;
            height: 15px;
            background: linear-gradient(to bottom, #c0c0c0, #808080);
            border-radius: 1px;
        }

        /* Pin Status */
        .pin-status {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
        }

        .pin-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .pin-led {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #333;
            border: 1px solid #555;
            transition: all 0.1s;
        }

        .pin-led.high {
            background: #00ff88;
            box-shadow: 0 0 8px #00ff88;
        }

        .pin-led.low {
            background: #ff4444;
            box-shadow: 0 0 8px #ff4444;
        }

        /* Timing Diagram - Canvas */
        .timing-container {
            background: #0a0a15;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 15px;
        }

        #timingCanvas {
            width: 100%;
            height: 160px;
            display: block;
        }

        /* Block Structure Visualization */
        .block-structure {
            background: #0a0a15;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .block-visual {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .block-rect {
            flex: 1;
            background: #1a1a2e;
            border: 2px solid #444;
            border-radius: 5px;
            padding: 10px;
            min-height: 200px;
            position: relative;
        }

        .block-rect.selected {
            border-color: #00ff88;
            box-shadow: 0 0 15px rgba(0,255,136,0.3);
        }

        .block-rect.bad {
            border-color: #ff4444;
            background: linear-gradient(135deg, #1a1a2e, #2a1515);
        }

        .block-header {
            font-size: 0.75rem;
            color: #00ccff;
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 1px solid #333;
        }

        .block-header span {
            color: #666;
            font-size: 0.65rem;
        }

        .pages-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 2px;
        }

        .page-cell {
            aspect-ratio: 1;
            background: #252540;
            border: 1px solid #333;
            border-radius: 2px;
            cursor: pointer;
            transition: all 0.15s;
            position: relative;
        }

        .page-cell:hover {
            background: #353560;
            transform: scale(1.1);
            z-index: 5;
        }

        .page-cell.programmed {
            background: #004400;
            border-color: #006600;
        }

        .page-cell.selected {
            border-color: #00ff88;
            box-shadow: 0 0 5px #00ff88;
        }

        .page-cell.busy {
            animation: pageBusy 0.3s ease-in-out infinite;
        }

        @keyframes pageBusy {
            0%, 100% { background: #ffaa00; }
            50% { background: #553300; }
        }

        .block-info {
            margin-top: 10px;
            font-size: 0.65rem;
            color: #666;
        }

        /* Page Size Diagram */
        .page-diagram {
            background: #0f0f1a;
            border: 1px solid #333;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
        }

        .page-bar {
            display: flex;
            height: 30px;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .page-data-area {
            flex: 2048;
            background: linear-gradient(90deg, #003366, #004488);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: #88ccff;
        }

        .page-spare-area {
            flex: 64;
            background: linear-gradient(90deg, #663300, #885500);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            color: #ffcc88;
        }

        .page-legend {
            display: flex;
            justify-content: space-between;
            font-size: 0.65rem;
            color: #888;
        }

        /* Command Console */
        .console {
            background: #0a0a15;
            border: 1px solid #333;
            border-radius: 5px;
            height: 180px;
            overflow-y: auto;
            padding: 10px;
            font-size: 0.7rem;
            margin-bottom: 15px;
        }

        .console-line { margin: 2px 0; }
        .console-line.cmd { color: #00ccff; }
        .console-line.ok { color: #00ff88; }
        .console-line.err { color: #ff4444; }
        .console-line.info { color: #ffaa00; }
        .console-line.data { color: #aa88ff; }

        /* Command Buttons */
        .cmd-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
            margin-bottom: 15px;
        }

        .cmd-btn {
            background: linear-gradient(145deg, #1a1a2e, #252540);
            border: 1px solid #444;
            color: #00ff88;
            padding: 10px 6px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 0.7rem;
            transition: all 0.2s;
        }

        .cmd-btn:hover {
            background: linear-gradient(145deg, #252540, #303055);
            border-color: #00ff88;
            box-shadow: 0 0 10px rgba(0,255,136,0.3);
        }

        .cmd-btn.danger { color: #ff4444; }
        .cmd-btn.warning { color: #ffaa00; }

        /* Address Input */
        .address-input {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .address-input input {
            flex: 1;
            background: #0a0a15;
            border: 1px solid #333;
            color: #00ff88;
            padding: 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
        }

        .address-input input:focus {
            outline: none;
            border-color: #00ff88;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .stat-item {
            background: rgba(0,0,0,0.3);
            padding: 10px 5px;
            border-radius: 5px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.1rem;
            color: #00ccff;
        }

        .stat-label {
            font-size: 0.6rem;
            color: #666;
            margin-top: 3px;
        }

        /* Data View */
        .data-view {
            background: #0a0a15;
            border-radius: 5px;
            padding: 8px;
            font-size: 0.6rem;
            max-height: 120px;
            overflow-y: auto;
        }

        .data-row {
            display: flex;
            margin: 1px 0;
        }

        .data-addr { color: #666; width: 55px; }
        .data-hex { color: #00ccff; flex: 1; letter-spacing: 1px; }
        .data-ascii { color: #aa88ff; width: 70px; }

        /* Status Bar */
        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #1a1a2e;
            border-top: 1px solid #333;
            padding: 8px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-led {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #00ff88;
        }

        .status-led.busy {
            background: #ffaa00;
            animation: blink 0.3s infinite;
        }

        @keyframes blink {
            50% { opacity: 0.3; }
        }

        @media (max-width: 1200px) {
            .container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>W29N04GZ NAND SIMULATOR</h1>
        <div class="subtitle">4Gb SLC NAND Flash | Winbond | Interactive Verilog Model</div>
    </div>

    <div class="container">
        <!-- Left Panel -->
        <div class="panel">
            <div class="panel-title">TSOP-48 Package</div>
            <div class="chip-container">
                <div class="pins-row" id="pinsTop"></div>
                <div class="chip">
                    <div class="chip-dot"></div>
                    <div class="chip-label">4Gb SLC NAND</div>
                </div>
                <div class="pins-row" id="pinsBottom"></div>
            </div>

            <div class="panel-title">Control Signals</div>
            <div class="pin-status" id="pinStatus"></div>

            <div class="panel-title" style="margin-top:15px">Chip Specs</div>
            <div class="stats-grid">
                <div class="stat-item"><div class="stat-value">4Gb</div><div class="stat-label">Density</div></div>
                <div class="stat-item"><div class="stat-value">4096</div><div class="stat-label">Blocks</div></div>
                <div class="stat-item"><div class="stat-value">64</div><div class="stat-label">Pages/Blk</div></div>
                <div class="stat-item"><div class="stat-value">2KB</div><div class="stat-label">Page Data</div></div>
                <div class="stat-item"><div class="stat-value">64B</div><div class="stat-label">Spare</div></div>
                <div class="stat-item"><div class="stat-value">100K</div><div class="stat-label">P/E Cycles</div></div>
            </div>
        </div>

        <!-- Center Panel -->
        <div class="panel">
            <div class="panel-title">Signal Timing (Live Waveform)</div>
            <div class="timing-container">
                <canvas id="timingCanvas"></canvas>
            </div>

            <div class="panel-title">Block & Page Structure</div>
            <div class="block-structure">
                <div class="block-visual">
                    <div class="block-rect" id="block0">
                        <div class="block-header">Block 0 <span>(Selected)</span></div>
                        <div class="pages-grid" id="pages0"></div>
                        <div class="block-info">64 pages × 2112 bytes = 132KB/block</div>
                    </div>
                    <div class="block-rect" id="block1">
                        <div class="block-header">Block 1</div>
                        <div class="pages-grid" id="pages1"></div>
                        <div class="block-info">Address: 0x21000 - 0x41FFF</div>
                    </div>
                    <div class="block-rect bad" id="block7">
                        <div class="block-header">Block 7 <span style="color:#ff4444">(BAD)</span></div>
                        <div class="pages-grid" id="pages7"></div>
                        <div class="block-info">Factory-marked bad block</div>
                    </div>
                </div>

                <div class="page-diagram">
                    <div style="font-size:0.7rem;color:#888;margin-bottom:8px;">Page Layout (2112 bytes total):</div>
                    <div class="page-bar">
                        <div class="page-data-area">Data Area (2048 bytes)</div>
                        <div class="page-spare-area">Spare (64B)</div>
                    </div>
                    <div class="page-legend">
                        <span>0x000</span>
                        <span>User Data + ECC</span>
                        <span>0x83F</span>
                    </div>
                </div>
            </div>

            <div class="panel-title">Console</div>
            <div class="console" id="console"></div>
        </div>

        <!-- Right Panel -->
        <div class="panel">
            <div class="panel-title">Commands</div>
            <div class="address-input">
                <input type="number" id="blockAddr" placeholder="Block" value="0" min="0" max="4095">
                <input type="number" id="pageAddr" placeholder="Page" value="0" min="0" max="63">
            </div>

            <div class="cmd-grid">
                <button class="cmd-btn" onclick="cmdReadID()">Read ID (90h)</button>
                <button class="cmd-btn" onclick="cmdReadStatus()">Status (70h)</button>
                <button class="cmd-btn" onclick="cmdReadPage()">Read Page (00h)</button>
                <button class="cmd-btn" onclick="cmdProgram()">Program (80h)</button>
                <button class="cmd-btn warning" onclick="cmdErase()">Erase (60h)</button>
                <button class="cmd-btn" onclick="cmdReset()">Reset (FFh)</button>
            </div>

            <div class="panel-title">Page Data View</div>
            <div class="data-view" id="dataView"></div>

            <div class="panel-title" style="margin-top:15px">Timing (from Verilog)</div>
            <div style="font-size:0.65rem;color:#666;line-height:1.6">
                tR (Read): 25µs<br>
                tPROG (Program): 250µs<br>
                tBERS (Erase): 2ms<br>
                tWC (Write Cycle): 25ns<br>
                tRC (Read Cycle): 25ns
            </div>

            <div class="panel-title" style="margin-top:15px">Operations</div>
            <div style="font-size:0.65rem;color:#666">
                <div>Erases: <span id="statErase" style="color:#00ccff">0</span></div>
                <div>Programs: <span id="statProg" style="color:#00ccff">0</span></div>
                <div>Reads: <span id="statRead" style="color:#00ccff">0</span></div>
            </div>
        </div>
    </div>

    <div class="status-bar">
        <div class="status-indicator">
            <div class="status-led" id="statusLed"></div>
            <span id="statusText">READY</span>
        </div>
        <div>State: <span id="stateText" style="color:#00ccff">IDLE</span></div>
        <div style="color:#666">VCC: 3.3V | R/B#: HIGH</div>
    </div>

    <script>
        // ============ NAND State ============
        const NAND = {
            BLOCKS: 4096,
            PAGES_PER_BLOCK: 64,
            PAGE_SIZE: 2112,
            memory: new Map(),
            badBlocks: new Set([7, 42, 128, 1024]),
            status: 0xE0,
            busy: false,
            stats: { erase: 0, prog: 0, read: 0 }
        };

        // ============ Timing Diagram ============
        const timing = {
            canvas: null,
            ctx: null,
            signals: {
                CLE:  { data: [], color: '#00ff88' },
                ALE:  { data: [], color: '#00ccff' },
                'WE#': { data: [], color: '#ffaa00' },
                'RE#': { data: [], color: '#ff88ff' },
                'I/O': { data: [], color: '#88ffff', isData: true },
                'R/B#': { data: [], color: '#ff4444' }
            },
            maxPoints: 100,
            time: 0
        };

        function initTiming() {
            timing.canvas = document.getElementById('timingCanvas');
            timing.ctx = timing.canvas.getContext('2d');
            timing.canvas.width = timing.canvas.offsetWidth * 2;
            timing.canvas.height = 160;

            // Initialize with idle state
            Object.keys(timing.signals).forEach(sig => {
                timing.signals[sig].data = new Array(timing.maxPoints).fill(sig === 'R/B#' ? 1 : 0);
            });
            drawTiming();
        }

        function addTimingPulse(signal, pattern) {
            // pattern is array of 0s and 1s to add
            const sig = timing.signals[signal];
            if (!sig) return;
            pattern.forEach(v => {
                sig.data.push(v);
                if (sig.data.length > timing.maxPoints) sig.data.shift();
            });
            drawTiming();
        }

        function drawTiming() {
            const ctx = timing.ctx;
            const w = timing.canvas.width;
            const h = timing.canvas.height;
            const sigNames = Object.keys(timing.signals);
            const sigHeight = h / sigNames.length;

            ctx.fillStyle = '#0a0a15';
            ctx.fillRect(0, 0, w, h);

            sigNames.forEach((name, i) => {
                const sig = timing.signals[name];
                const y = i * sigHeight;
                const midY = y + sigHeight / 2;
                const high = y + 8;
                const low = y + sigHeight - 8;

                // Label
                ctx.fillStyle = '#666';
                ctx.font = '11px monospace';
                ctx.fillText(name, 5, midY + 4);

                // Waveform
                ctx.strokeStyle = sig.color;
                ctx.lineWidth = 2;
                ctx.beginPath();

                const startX = 45;
                const stepX = (w - startX - 10) / timing.maxPoints;

                sig.data.forEach((val, j) => {
                    const x = startX + j * stepX;
                    const yPos = val ? high : low;
                    if (j === 0) {
                        ctx.moveTo(x, yPos);
                    } else {
                        const prevVal = sig.data[j - 1];
                        if (prevVal !== val) {
                            ctx.lineTo(x, prevVal ? high : low);
                            ctx.lineTo(x, yPos);
                        }
                        ctx.lineTo(x + stepX, yPos);
                    }
                });
                ctx.stroke();

                // Separator line
                ctx.strokeStyle = '#222';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(0, y + sigHeight);
                ctx.lineTo(w, y + sigHeight);
                ctx.stroke();
            });
        }

        // ============ Block/Page Visualization ============
        function initBlocks() {
            [0, 1, 7].forEach(blockNum => {
                const container = document.getElementById(`pages${blockNum}`);
                if (!container) return;
                container.innerHTML = '';
                for (let p = 0; p < 64; p++) {
                    const cell = document.createElement('div');
                    cell.className = 'page-cell';
                    cell.title = `Page ${p}`;
                    cell.dataset.block = blockNum;
                    cell.dataset.page = p;
                    cell.onclick = () => selectPage(blockNum, p);
                    container.appendChild(cell);
                }
            });
        }

        function selectPage(block, page) {
            document.getElementById('blockAddr').value = block;
            document.getElementById('pageAddr').value = page;
            document.querySelectorAll('.page-cell').forEach(c => c.classList.remove('selected'));
            const cell = document.querySelector(`.page-cell[data-block="${block}"][data-page="${page}"]`);
            if (cell) cell.classList.add('selected');
        }

        function updatePageVisual(block, page, state) {
            const cell = document.querySelector(`.page-cell[data-block="${block}"][data-page="${page}"]`);
            if (cell) {
                cell.classList.remove('programmed', 'busy');
                if (state) cell.classList.add(state);
            }
        }

        function clearBlockVisual(block) {
            document.querySelectorAll(`.page-cell[data-block="${block}"]`).forEach(c => {
                c.classList.remove('programmed', 'busy');
            });
        }

        // ============ Pin Status ============
        const pins = { CLE: 0, ALE: 0, CE: 0, WE: 1, RE: 1, WP: 1, RB: 1 };

        function initPins() {
            // Create pin visuals
            for (let i = 0; i < 24; i++) {
                document.getElementById('pinsTop').innerHTML += '<div class="pin"></div>';
                document.getElementById('pinsBottom').innerHTML += '<div class="pin"></div>';
            }

            // Create status indicators
            const container = document.getElementById('pinStatus');
            ['CLE', 'ALE', 'CE#', 'WE#', 'RE#', 'WP#', 'R/B#'].forEach(pin => {
                const div = document.createElement('div');
                div.className = 'pin-item';
                const id = pin.replace(/[#\/]/g, '');
                div.innerHTML = `<div class="pin-led" id="led${id}"></div><span>${pin}</span>`;
                container.appendChild(div);
            });
            updatePinDisplay();
        }

        function setPin(name, value) {
            pins[name] = value;
            updatePinDisplay();
        }

        function updatePinDisplay() {
            document.getElementById('ledCLE').className = `pin-led ${pins.CLE ? 'high' : ''}`;
            document.getElementById('ledALE').className = `pin-led ${pins.ALE ? 'high' : ''}`;
            document.getElementById('ledCE').className = `pin-led ${pins.CE ? '' : 'high'}`;
            document.getElementById('ledWE').className = `pin-led ${pins.WE ? '' : 'high'}`;
            document.getElementById('ledRE').className = `pin-led ${pins.RE ? '' : 'high'}`;
            document.getElementById('ledWP').className = `pin-led ${pins.WP ? '' : 'low'}`;
            document.getElementById('ledRB').className = `pin-led ${pins.RB ? 'high' : 'low'}`;
        }

        // ============ Console & Status ============
        function log(type, msg) {
            const con = document.getElementById('console');
            const line = document.createElement('div');
            line.className = `console-line ${type}`;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            con.appendChild(line);
            con.scrollTop = con.scrollHeight;
        }

        function setStatus(busy, text, state) {
            NAND.busy = busy;
            document.getElementById('statusLed').className = `status-led ${busy ? 'busy' : ''}`;
            document.getElementById('statusText').textContent = text;
            document.getElementById('stateText').textContent = state;
            pins.RB = busy ? 0 : 1;
            updatePinDisplay();
        }

        function updateStats() {
            document.getElementById('statErase').textContent = NAND.stats.erase;
            document.getElementById('statProg').textContent = NAND.stats.prog;
            document.getElementById('statRead').textContent = NAND.stats.read;
        }

        // ============ Data View ============
        function updateDataView(block = 0, page = 0) {
            const container = document.getElementById('dataView');
            container.innerHTML = '';
            const key = `${block}:${page}`;
            const data = NAND.memory.get(key) || new Uint8Array(128).fill(0xFF);

            for (let i = 0; i < 128; i += 16) {
                const row = document.createElement('div');
                row.className = 'data-row';
                const hex = Array.from(data.slice(i, i + 16)).map(b =>
                    b.toString(16).toUpperCase().padStart(2, '0')).join(' ');
                const ascii = Array.from(data.slice(i, i + 16)).map(b =>
                    (b >= 32 && b <= 126) ? String.fromCharCode(b) : '.').join('');
                row.innerHTML = `<span class="data-addr">${i.toString(16).padStart(4, '0')}:</span>
                    <span class="data-hex">${hex}</span><span class="data-ascii">${ascii}</span>`;
                container.appendChild(row);
            }
        }

        // ============ Commands ============
        async function cmdReadID() {
            log('cmd', '>> READ ID (90h)');

            // Timing: Command phase
            addTimingPulse('CLE', [1,1,1,0]);
            addTimingPulse('WE#', [0,1,0,1]);
            addTimingPulse('I/O', [1,1,1,0]);
            addTimingPulse('ALE', [0,0,0,0]);
            addTimingPulse('RE#', [1,1,1,1]);
            addTimingPulse('R/B#', [1,1,1,1]);

            setPin('CLE', 1); await delay(30); setPin('CLE', 0);

            // Data out phase
            addTimingPulse('RE#', [0,1,0,1,0,1,0,1,0,1]);
            addTimingPulse('I/O', [1,0,1,0,1,0,1,0,1,0]);

            log('data', 'ID: EF AC 90 15 54');
            log('info', 'Mfr: Winbond | Device: W29N04GZ | 4Gb SLC');
            setStatus(false, 'READY', 'IDLE');
        }

        async function cmdReadStatus() {
            log('cmd', '>> READ STATUS (70h)');
            addTimingPulse('CLE', [1,1,0,0]);
            addTimingPulse('WE#', [0,1,1,1]);
            addTimingPulse('RE#', [1,1,0,1]);
            addTimingPulse('I/O', [1,0,1,0]);
            addTimingPulse('ALE', [0,0,0,0]);
            addTimingPulse('R/B#', [1,1,1,1]);

            const bits = ['PASS', 'READY', 'READY', 'WP_OFF'];
            log('data', `Status: 0xE0 [${bits.join(' | ')}]`);
        }

        async function cmdReadPage() {
            const block = parseInt(document.getElementById('blockAddr').value) || 0;
            const page = parseInt(document.getElementById('pageAddr').value) || 0;

            log('cmd', `>> READ PAGE Block:${block} Page:${page}`);

            // Command + Address phases
            addTimingPulse('CLE', [1,1,0,0,0,0,0,0,0,1,1,0]);
            addTimingPulse('ALE', [0,0,1,1,1,1,1,0,0,0,0,0]);
            addTimingPulse('WE#', [0,1,0,1,0,1,0,1,0,1,0,1]);
            addTimingPulse('RE#', [1,1,1,1,1,1,1,1,1,1,1,1]);
            addTimingPulse('I/O', [1,0,1,0,1,0,1,0,1,0,1,0]);
            addTimingPulse('R/B#', [1,1,1,1,1,0,0,0,0,0,1,1]);

            setStatus(true, 'BUSY - Reading', 'READ');
            selectPage(block, page);
            updatePageVisual(block, page, 'busy');

            await delay(100);

            // Data out phase
            addTimingPulse('RE#', [0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1]);
            addTimingPulse('I/O', [1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0]);
            addTimingPulse('R/B#', [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]);

            updatePageVisual(block, page, NAND.memory.has(`${block}:${page}`) ? 'programmed' : '');
            updateDataView(block, page);
            NAND.stats.read++;
            updateStats();

            log('ok', `Read complete: 2112 bytes`);
            setStatus(false, 'READY', 'IDLE');
        }

        async function cmdProgram() {
            const block = parseInt(document.getElementById('blockAddr').value) || 0;
            const page = parseInt(document.getElementById('pageAddr').value) || 0;

            if (NAND.badBlocks.has(block)) {
                log('err', `Block ${block} is BAD - program rejected`);
                return;
            }

            log('cmd', `>> PROGRAM Block:${block} Page:${page}`);

            // Command + Address + Data In + Confirm
            addTimingPulse('CLE', [1,1,0,0,0,0,0,0,0,0,0,0,1,1,0]);
            addTimingPulse('ALE', [0,0,1,1,1,1,1,0,0,0,0,0,0,0,0]);
            addTimingPulse('WE#', [0,1,0,1,0,1,0,1,0,1,0,1,0,1,0]);
            addTimingPulse('I/O', [1,0,1,0,1,0,1,0,1,0,1,0,1,0,0]);
            addTimingPulse('RE#', [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]);
            addTimingPulse('R/B#', [1,1,1,1,1,1,1,1,1,0,0,0,0,0,0]);

            setStatus(true, 'BUSY - Programming', 'PROGRAM');
            updatePageVisual(block, page, 'busy');

            await delay(150);

            addTimingPulse('R/B#', [0,0,0,0,1,1,1,1,1,1]);

            // Store random data
            const data = new Uint8Array(128);
            for (let i = 0; i < 128; i++) data[i] = Math.floor(Math.random() * 256);
            NAND.memory.set(`${block}:${page}`, data);

            updatePageVisual(block, page, 'programmed');
            updateDataView(block, page);
            NAND.stats.prog++;
            updateStats();

            log('ok', `Program complete: 2112 bytes written`);
            setStatus(false, 'READY', 'IDLE');
        }

        async function cmdErase() {
            const block = parseInt(document.getElementById('blockAddr').value) || 0;

            if (NAND.badBlocks.has(block)) {
                log('err', `Block ${block} is BAD - erase rejected`);
                return;
            }

            log('cmd', `>> ERASE Block:${block}`);

            addTimingPulse('CLE', [1,1,0,0,0,0,1,1,0,0,0,0,0,0,0]);
            addTimingPulse('ALE', [0,0,1,1,1,0,0,0,0,0,0,0,0,0,0]);
            addTimingPulse('WE#', [0,1,0,1,0,1,0,1,0,0,0,0,0,0,0]);
            addTimingPulse('I/O', [1,0,1,0,1,0,1,0,0,0,0,0,0,0,0]);
            addTimingPulse('RE#', [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]);
            addTimingPulse('R/B#', [1,1,1,1,1,1,1,0,0,0,0,0,0,0,0]);

            setStatus(true, 'BUSY - Erasing', 'ERASE');

            // Animate all pages
            for (let p = 0; p < 64; p++) {
                updatePageVisual(block, p, 'busy');
            }

            await delay(200);

            addTimingPulse('R/B#', [0,0,0,0,0,1,1,1,1,1]);

            // Clear memory
            for (let p = 0; p < 64; p++) {
                NAND.memory.delete(`${block}:${p}`);
            }
            clearBlockVisual(block);
            updateDataView(block, 0);
            NAND.stats.erase++;
            updateStats();

            log('ok', `Erase complete: Block ${block} (64 pages = 132KB)`);
            setStatus(false, 'READY', 'IDLE');
        }

        async function cmdReset() {
            log('cmd', '>> RESET (FFh)');
            addTimingPulse('CLE', [1,1,1,0,0,0,0,0]);
            addTimingPulse('WE#', [0,0,1,1,1,1,1,1]);
            addTimingPulse('R/B#', [1,1,1,0,0,0,1,1]);
            addTimingPulse('ALE', [0,0,0,0,0,0,0,0]);
            addTimingPulse('RE#', [1,1,1,1,1,1,1,1]);
            addTimingPulse('I/O', [1,1,0,0,0,0,0,0]);

            setStatus(true, 'RESETTING', 'RESET');
            await delay(50);
            NAND.status = 0xE0;
            log('ok', 'Reset complete');
            setStatus(false, 'READY', 'IDLE');
        }

        function delay(ms) {
            return new Promise(r => setTimeout(r, ms));
        }

        // ============ Init ============
        window.onload = function() {
            initPins();
            initBlocks();
            initTiming();
            updateDataView();
            log('info', 'W29N04GZ Simulator Ready');
            log('info', 'Model: w29n04gz.vp (Verilog)');
            log('ok', 'Power-on complete');
        };

        window.onresize = function() {
            timing.canvas.width = timing.canvas.offsetWidth * 2;
            drawTiming();
        };
    </script>
</body>
</html>
